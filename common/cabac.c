/*****************************************************************************
 * cabac.c: arithmetic coder
 *****************************************************************************/

#include "common.h"

/**************************************************************************
 * Values of variables m and n for ctxIdx from 0 to 1023                  *
 * Table 9-11 to 9-33 of <ITU-T-REC-H.264-201201.pdf>                     *
 *                                                                        *
 * 1. chroma 420/422 uses 460 items, chroma 444 uses 1024 items.          *
 * 2. if dct 8x8 disabled, only 399 items are used.                       *
 * 3. if field encoding disabled, only 276 items are used.                *
 * 4. only i_cabac_init_idc = 0 is used, remove i_cabac_init_idc = 1 or 2 *
 **************************************************************************/
static const int8_t x264_cabac_context_init_I[460][2] =
{
    /* 0 - 10 */
    { 20, -15 }, {  2, 54 },  {  3,  74 }, { 20, -15 },
    {  2,  54 }, {  3, 74 },  { -28,127 }, { -23, 104 },
    { -6,  53 }, { -1, 54 },  {  7,  51 },

    /* 11 - 23 unused for I */
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },

    /* 24- 39 */
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },

    /* 40 - 53 */
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },

    /* 54 - 59 */
    { 0, 0 },    { 0, 0 },    { 0, 0 },      { 0, 0 },
    { 0, 0 },    { 0, 0 },

    /* 60 - 69 */
    { 0, 41 },   { 0, 63 },   { 0, 63 },     { 0, 63 },
    { -9, 83 },  { 4, 86 },   { 0, 97 },     { -7, 72 },
    { 13, 41 },  { 3, 62 },

    /* 70 -> 87 */
    { 0, 11 },   { 1, 55 },   { 0, 69 },     { -17, 127 },
    { -13, 102 },{ 0, 82 },   { -7, 74 },    { -21, 107 },
    { -27, 127 },{ -31, 127 },{ -24, 127 },  { -18, 95 },
    { -27, 127 },{ -21, 114 },{ -30, 127 },  { -17, 123 },
    { -12, 115 },{ -16, 122 },

    /* 88 -> 104 */
    { -11, 115 },{ -12, 63 }, { -2, 68 },    { -15, 84 },
    { -13, 104 },{ -3, 70 },  { -8, 93 },    { -10, 90 },
    { -30, 127 },{ -1, 74 },  { -6, 97 },    { -7, 91 },
    { -20, 127 },{ -4, 56 },  { -5, 82 },    { -7, 76 },
    { -22, 125 },

    /* 105 -> 135 */
    { -7, 93 },  { -11, 87 }, { -3, 77 },    { -5, 71 },
    { -4, 63 },  { -4, 68 },  { -12, 84 },   { -7, 62 },
    { -7, 65 },  { 8, 61 },   { 5, 56 },     { -2, 66 },
    { 1, 64 },   { 0, 61 },   { -2, 78 },    { 1, 50 },
    { 7, 52 },   { 10, 35 },  { 0, 44 },     { 11, 38 },
    { 1, 45 },   { 0, 46 },   { 5, 44 },     { 31, 17 },
    { 1, 51 },   { 7, 50 },   { 28, 19 },    { 16, 33 },
    { 14, 62 },  { -13, 108 },{ -15, 100 },

    /* 136 -> 165 */
    { -13, 101 },{ -13, 91 }, { -12, 94 },   { -10, 88 },
    { -16, 84 }, { -10, 86 }, { -7, 83 },    { -13, 87 },
    { -19, 94 }, { 1, 70 },   { 0, 72 },     { -5, 74 },
    { 18, 59 },  { -8, 102 }, { -15, 100 },  { 0, 95 },
    { -4, 75 },  { 2, 72 },   { -11, 75 },   { -3, 71 },
    { 15, 46 },  { -13, 69 }, { 0, 62 },     { 0, 65 },
    { 21, 37 },  { -15, 72 }, { 9, 57 },     { 16, 54 },
    { 0, 62 },   { 12, 72 },

    /* 166 -> 196 */
    { 24, 0 },   { 15, 9 },   { 8, 25 },     { 13, 18 },
    { 15, 9 },   { 13, 19 },  { 10, 37 },    { 12, 18 },
    { 6, 29 },   { 20, 33 },  { 15, 30 },    { 4, 45 },
    { 1, 58 },   { 0, 62 },   { 7, 61 },     { 12, 38 },
    { 11, 45 },  { 15, 39 },  { 11, 42 },    { 13, 44 },
    { 16, 45 },  { 12, 41 },  { 10, 49 },    { 30, 34 },
    { 18, 42 },  { 10, 55 },  { 17, 51 },    { 17, 46 },
    { 0, 89 },   { 26, -19 }, { 22, -17 },

    /* 197 -> 226 */
    { 26, -17 }, { 30, -25 }, { 28, -20 },   { 33, -23 },
    { 37, -27 }, { 33, -23 }, { 40, -28 },   { 38, -17 },
    { 33, -11 }, { 40, -15 }, { 41, -6 },    { 38, 1 },
    { 41, 17 },  { 30, -6 },  { 27, 3 },     { 26, 22 },
    { 37, -16 }, { 35, -4 },  { 38, -8 },    { 38, -3 },
    { 37, 3 },   { 38, 5 },   { 42, 0 },     { 35, 16 },
    { 39, 22 },  { 14, 48 },  { 27, 37 },    { 21, 60 },
    { 12, 68 },  { 2, 97 },

    /* 227 -> 251 */
    { -3, 71 },  { -6, 42 },  { -5, 50 },    { -3, 54 },
    { -2, 62 },  { 0, 58 },   { 1, 63 },     { -2, 72 },
    { -1, 74 },  { -9, 91 },  { -5, 67 },    { -5, 27 },
    { -3, 39 },  { -2, 44 },  { 0, 46 },     { -16, 64 },
    { -8, 68 },  { -10, 78 }, { -6, 77 },    { -10, 86 },
    { -12, 92 }, { -15, 55 }, { -10, 60 },   { -6, 62 },
    { -4, 65 },

    /* 252 -> 275 */
    { -12, 73 }, { -8, 76 },  { -7, 80 },    { -9, 88 },
    { -17, 110 },{ -11, 97 }, { -20, 84 },   { -11, 79 },
    { -6, 73 },  { -4, 74 },  { -13, 86 },   { -13, 96 },
    { -11, 97 }, { -19, 117 },{ -8, 78 },    { -5, 33 },
    { -4, 48 },  { -2, 53 },  { -3, 62 },    { -13, 71 },
    { -10, 79 }, { -12, 86 }, { -13, 90 },   { -14, 97 },

    /* 276 a bit special (not used, x264_cabac_encode_bypass is used instead) */
    { 0, 0 },

    /* 277 -> 307 */
    { -6, 93 },  { -6, 84 },  { -8, 79 },    { 0, 66 },
    { -1, 71 },  { 0, 62 },   { -2, 60 },    { -2, 59 },
    { -5, 75 },  { -3, 62 },  { -4, 58 },    { -9, 66 },
    { -1, 79 },  { 0, 71 },   { 3, 68 },     { 10, 44 },
    { -7, 62 },  { 15, 36 },  { 14, 40 },    { 16, 27 },
    { 12, 29 },  { 1, 44 },   { 20, 36 },    { 18, 32 },
    { 5, 42 },   { 1, 48 },   { 10, 62 },    { 17, 46 },
    { 9, 64 },   { -12, 104 },{ -11, 97 },

    /* 308 -> 337 */
    { -16, 96 }, { -7, 88 },  { -8, 85 },    { -7, 85 },
    { -9, 85 },  { -13, 88 }, { 4, 66 },     { -3, 77 },
    { -3, 76 },  { -6, 76 },  { 10, 58 },    { -1, 76 },
    { -1, 83 },  { -7, 99 },  { -14, 95 },   { 2, 95 },
    { 0, 76 },   { -5, 74 },  { 0, 70 },     { -11, 75 },
    { 1, 68 },   { 0, 65 },   { -14, 73 },   { 3, 62 },
    { 4, 62 },   { -1, 68 },  { -13, 75 },   { 11, 55 },
    { 5, 64 },   { 12, 70 },

    /* 338 -> 368 */
    { 15, 6 },   { 6, 19 },   { 7, 16 },     { 12, 14 },
    { 18, 13 },  { 13, 11 },  { 13, 15 },    { 15, 16 },
    { 12, 23 },  { 13, 23 },  { 15, 20 },    { 14, 26 },
    { 14, 44 },  { 17, 40 },  { 17, 47 },    { 24, 17 },
    { 21, 21 },  { 25, 22 },  { 31, 27 },    { 22, 29 },
    { 19, 35 },  { 14, 50 },  { 10, 57 },    { 7, 63 },
    { -2, 77 },  { -4, 82 },  { -3, 94 },    { 9, 69 },
    { -12, 109 },{ 36, -35 }, { 36, -34 },

    /* 369 -> 398 */
    { 32, -26 }, { 37, -30 }, { 44, -32 },   { 34, -18 },
    { 34, -15 }, { 40, -15 }, { 33, -7 },    { 35, -5 },
    { 33, 0 },   { 38, 2 },   { 33, 13 },    { 23, 35 },
    { 13, 58 },  { 29, -3 },  { 26, 0 },     { 22, 30 },
    { 31, -7 },  { 35, -15 }, { 34, -3 },    { 34, 3 },
    { 36, -1 },  { 34, 5 },   { 32, 11 },    { 35, 5 },
    { 34, 12 },  { 39, 11 },  { 30, 29 },    { 34, 26 },
    { 29, 39 },  { 19, 66 },

    /* 399 -> 435 */
    {  31,  21 }, {  31,  31 }, {  25,  50 },
    { -17, 120 }, { -20, 112 }, { -18, 114 }, { -11,  85 },
    { -15,  92 }, { -14,  89 }, { -26,  71 }, { -15,  81 },
    { -14,  80 }, {   0,  68 }, { -14,  70 }, { -24,  56 },
    { -23,  68 }, { -24,  50 }, { -11,  74 }, {  23, -13 },
    {  26, -13 }, {  40, -15 }, {  49, -14 }, {  44,   3 },
    {  45,   6 }, {  44,  34 }, {  33,  54 }, {  19,  82 },
    {  -3,  75 }, {  -1,  23 }, {   1,  34 }, {   1,  43 },
    {   0,  54 }, {  -2,  55 }, {   0,  61 }, {   1,  64 },
    {   0,  68 }, {  -9,  92 },

    /* 436 -> 459 */
    { -14, 106 }, { -13,  97 }, { -15,  90 }, { -12,  90 },
    { -18,  88 }, { -10,  73 }, {  -9,  79 }, { -14,  86 },
    { -10,  73 }, { -10,  70 }, { -10,  69 }, {  -5,  66 },
    {  -9,  64 }, {  -5,  58 }, {   2,  59 }, {  21, -10 },
    {  24, -11 }, {  28,  -8 }, {  28,  -1 }, {  29,   3 },
    {  29,   9 }, {  35,  20 }, {  29,  36 }, {  14,  67 }

    /* 460 -> 1024 */
};

/* only i_cabac_init_idc == 0 is defined here */
static const int8_t x264_cabac_context_init_PB[460][2] =
{
	/* 0 - 10 */
	{  20, -15 }, {   2,  54 }, {   3,  74 }, {  20, -15 },
	{   2,  54 }, {   3,  74 }, { -28, 127 }, { -23, 104 },
	{  -6,  53 }, {  -1,  54 }, {   7,  51 },

	/* 11 - 23 */
	{  23,  33 }, {  23,   2 }, {  21,   0 }, {   1,   9 },
	{   0,  49 }, { -37, 118 }, {   5,  57 }, { -13,  78 },
	{ -11,  65 }, {   1,  62 }, {  12,  49 }, {  -4,  73 },
	{  17,  50 },

	/* 24 - 39 */
	{  18,  64 }, {   9,  43 }, {  29,   0 }, {  26,  67 },
	{  16,  90 }, {   9, 104 }, { -46, 127 }, { -20, 104 },
	{   1,  67 }, { -13,  78 }, { -11,  65 }, {   1,  62 },
	{  -6,  86 }, { -17,  95 }, {  -6,  61 }, {   9,  45 },

	/* 40 - 53 */
	{  -3,  69 }, {  -6,  81 }, { -11,  96 }, {   6,  55 },
	{   7,  67 }, {  -5,  86 }, {   2,  88 }, {   0,  58 },
	{  -3,  76 }, { -10,  94 }, {   5,  54 }, {   4,  69 },
	{  -3,  81 }, {   0,  88 },

	/* 54 - 59 */
	{  -7,  67 }, {  -5,  74 }, {  -4,  74 }, {  -5,  80 },
	{  -7,  72 }, {   1,  58 },

	/* 60 - 69 */
	{   0,  41 }, {   0,  63 }, {   0,  63 }, { 0, 63 },
	{  -9,  83 }, {   4,  86 }, {   0,  97 }, { -7, 72 },
	{  13,  41 }, {   3,  62 },

	/* 70 - 87 */
	{   0,  45 }, {  -4,  78 }, {  -3,  96 }, { -27,  126 },
	{ -28,  98 }, { -25, 101 }, { -23,  67 }, { -28,  82 },
	{ -20,  94 }, { -16,  83 }, { -22, 110 }, { -21,  91 },
	{ -18, 102 }, { -13,  93 }, { -29, 127 }, {  -7,  92 },
	{  -5,  89 }, {  -7,  96 }, { -13, 108 }, {  -3,  46 },
	{  -1,  65 }, {  -1,  57 }, {  -9,  93 }, {  -3,  74 },
	{  -9,  92 }, {  -8,  87 }, { -23, 126 }, {   5,  54 },
	{   6,  60 }, {   6,  59 }, {   6,  69 }, {  -1,  48 },
	{   0,  68 }, {  -4,  69 }, {  -8,  88 },

	/* 105 -> 165 */
	{  -2,  85 }, {  -6,  78 }, {  -1,  75 }, {  -7,  77 },
	{   2,  54 }, {   5,  50 }, {  -3,  68 }, {   1,  50 },
	{   6,  42 }, {  -4,  81 }, {   1,  63 }, {  -4,  70 },
	{   0,  67 }, {   2,  57 }, {  -2,  76 }, {  11,  35 },
	{   4,  64 }, {   1,  61 }, {  11,  35 }, {  18,  25 },
	{  12,  24 }, {  13,  29 }, {  13,  36 }, { -10,  93 },
	{  -7,  73 }, {  -2,  73 }, {  13,  46 }, {   9,  49 },
	{  -7, 100 }, {   9,  53 }, {   2,  53 }, {   5,  53 },
	{  -2,  61 }, {   0,  56 }, {   0,  56 }, { -13,  63 },
	{  -5,  60 }, {  -1,  62 }, {   4,  57 }, {  -6,  69 },
	{   4,  57 }, {  14,  39 }, {   4,  51 }, {  13,  68 },
	{   3,  64 }, {   1,  61 }, {   9,  63 }, {   7,  50 },
	{  16,  39 }, {   5,  44 }, {   4,  52 }, {  11,  48 },
	{  -5,  60 }, {  -1,  59 }, {   0,  59 }, {  22,  33 },
	{   5,  44 }, {  14,  43 }, {  -1,  78 }, {   0,  60 },
	{   9,  69 },

	/* 166 - 226 */
	{  11,  28 }, {   2,  40 }, {   3,  44 }, {   0,  49 },
	{   0,  46 }, {   2,  44 }, {   2,  51 }, {   0,  47 },
	{   4,  39 }, {   2,  62 }, {   6,  46 }, {   0,  54 },
	{   3,  54 }, {   2,  58 }, {   4,  63 }, {   6,  51 },
	{   6,  57 }, {   7,  53 }, {   6,  52 }, {   6,  55 },
	{  11,  45 }, {  14,  36 }, {   8,  53 }, {  -1,  82 },
	{   7,  55 }, {  -3,  78 }, {  15,  46 }, {  22,  31 },
	{  -1,  84 }, {  25,   7 }, {  30,  -7 }, {  28,   3 },
	{  28,   4 }, {  32,   0 }, {  34,  -1 }, {  30,   6 },
	{  30,   6 }, {  32,   9 }, {  31,  19 }, {  26,  27 },
	{  26,  30 }, {  37,  20 }, {  28,  34 }, {  17,  70 },
	{   1,  67 }, {   5,  59 }, {   9,  67 }, {  16,  30 },
	{  18,  32 }, {  18,  35 }, {  22,  29 }, {  24,  31 },
	{  23,  38 }, {  18,  43 }, {  20,  41 }, {  11,  63 },
	{   9,  59 }, {   9,  64 }, {  -1,  94 }, {  -2,  89 },
	{  -9, 108 },

	/* 227 - 275 */
	{  -6,  76 }, {  -2,  44 }, {   0,  45 }, {   0,  52 },
	{  -3,  64 }, {  -2,  59 }, {  -4,  70 }, {  -4,  75 },
	{  -8,  82 }, { -17, 102 }, {  -9,  77 }, {   3,  24 },
	{   0,  42 }, {   0,  48 }, {   0,  55 }, {  -6,  59 },
	{  -7,  71 }, { -12,  83 }, { -11,  87 }, { -30, 119 },
	{   1,  58 }, {  -3,  29 }, {  -1,  36 }, {   1,  38 },
	{   2,  43 }, {  -6,  55 }, {   0,  58 }, {   0,  64 },
	{  -3,  74 }, { -10,  90 }, {   0,  70 }, {  -4,  29 },
	{   5,  31 }, {   7,  42 }, {   1,  59 }, {  -2,  58 },
	{  -3,  72 }, {  -3,  81 }, { -11,  97 }, {   0,  58 },
	{   8,   5 }, {  10,  14 }, {  14,  18 }, {  13,  27 },
	{   2,  40 }, {   0,  58 }, {  -3,  70 }, {  -6,  79 },
	{  -8,  85 },

	/* 276 a bit special (not used, x264_cabac_encode_bypass is used instead) */
	{ 0, 0 },

	/* 277 - 337 */
	{ -13, 106 }, { -16, 106 }, { -10,  87 }, { -21, 114 },
	{ -18, 110 }, { -14,  98 }, { -22, 110 }, { -21, 106 },
	{ -18, 103 }, { -21, 107 }, { -23, 108 }, { -26, 112 },
	{ -10,  96 }, { -12,  95 }, {  -5,  91 }, {  -9,  93 },
	{ -22,  94 }, {  -5,  86 }, {   9,  67 }, {  -4,  80 },
	{ -10,  85 }, {  -1,  70 }, {   7,  60 }, {   9,  58 },
	{   5,  61 }, {  12,  50 }, {  15,  50 }, {  18,  49 },
	{  17,  54 }, {  10,  41 }, {   7,  46 }, {  -1,  51 },
	{   7,  49 }, {   8,  52 }, {   9,  41 }, {   6,  47 },
	{   2,  55 }, {  13,  41 }, {  10,  44 }, {   6,  50 },
	{   5,  53 }, {  13,  49 }, {   4,  63 }, {   6,  64 },
	{  -2,  69 }, {  -2,  59 }, {   6,  70 }, {  10,  44 },
	{   9,  31 }, {  12,  43 }, {   3,  53 }, {  14,  34 },
	{  10,  38 }, {  -3,  52 }, {  13,  40 }, {  17,  32 },
	{   7,  44 }, {   7,  38 }, {  13,  50 }, {  10,  57 },
	{  26,  43 },

	/* 338 - 398 */
	{  14,  11 }, {  11,  14 }, {   9,  11 }, {  18,  11 },
	{  21,   9 }, {  23,  -2 }, {  32, -15 }, {  32, -15 },
	{  34, -21 }, {  39, -23 }, {  42, -33 }, {  41, -31 },
	{  46, -28 }, {  38, -12 }, {  21,  29 }, {  45, -24 },
	{  53, -45 }, {  48, -26 }, {  65, -43 }, {  43, -19 },
	{  39, -10 }, {  30,   9 }, {  18,  26 }, {  20,  27 },
	{   0,  57 }, { -14,  82 }, {  -5,  75 }, { -19,  97 },
	{ -35, 125 }, {  27,   0 }, {  28,   0 }, {  31,  -4 },
	{  27,   6 }, {  34,   8 }, {  30,  10 }, {  24,  22 },
	{  33,  19 }, {  22,  32 }, {  26,  31 }, {  21,  41 },
	{  26,  44 }, {  23,  47 }, {  16,  65 }, {  14,  71 },
	{   8,  60 }, {   6,  63 }, {  17,  65 }, {  21,  24 },
	{  23,  20 }, {  26,  23 }, {  27,  32 }, {  28,  23 },
	{  28,  24 }, {  23,  40 }, {  24,  32 }, {  28,  29 },
	{  23,  42 }, {  19,  57 }, {  22,  53 }, {  22,  61 },
	{  11,  86 },

	/* 399 -> 435 */
	{  12,  40 }, {  11,  51 }, {  14,  59 },
	{  -4,  79 }, {  -7,  71 }, {  -5,  69 }, {  -9,  70 },
	{  -8,  66 }, { -10,  68 }, { -19,  73 }, { -12,  69 },
	{ -16,  70 }, { -15,  67 }, { -20,  62 }, { -19,  70 },
	{ -16,  66 }, { -22,  65 }, { -20,  63 }, {   9,  -2 },
	{  26,  -9 }, {  33,  -9 }, {  39,  -7 }, {  41,  -2 },
	{  45,   3 }, {  49,   9 }, {  45,  27 }, {  36,  59 },
	{  -6,  66 }, {  -7,  35 }, {  -7,  42 }, {  -8,  45 },
	{  -5,  48 }, { -12,  56 }, {  -6,  60 }, {  -5,  62 },
	{  -8,  66 }, {  -8,  76 },

	/* 436 -> 459 */
	{  -5,  85 }, {  -6,  81 }, { -10,  77 }, {  -7,  81 },
	{ -17,  80 }, { -18,  73 }, {  -4,  74 }, { -10,  83 },
	{  -9,  71 }, {  -9,  67 }, {  -1,  61 }, {  -8,  66 },
	{ -14,  66 }, {   0,  59 }, {   2,  59 }, {  21, -13 },
	{  33, -14 }, {  39,  -7 }, {  46,  -2 }, {  51,   2 },
	{  60,   6 }, {  61,  17 }, {  55,  34 }, {  42,  62 }

	/* 460 - 1024 */
};

/*************************************************************************
 * Table 9-44 of <ITU-T-REC-H.264-201201.pdf>                            *
 * Specification of rangeTabLPS depending on pStateIdx and qCodIRangeIdx *
 * LPS(Least Probability Symbol) range lookup table. R = R X Px          *
 * 1. Px: probability index of LPS. range: [1~63]. cb->i_state >> 1      *
 * 2. R: original range. range:[0~3]. (cb->i_range >> 6) - 4             *
 *************************************************************************/
const uint8_t x264_cabac_range_lps[64][4] =
{
    {  2,   2,   2,   2}, {  6,   7,   8,   9}, {  6,   7,   9,  10}, {  6,   8,   9,  11},
    {  7,   8,  10,  11}, {  7,   9,  10,  12}, {  7,   9,  11,  12}, {  8,   9,  11,  13},
    {  8,  10,  12,  14}, {  9,  11,  12,  14}, {  9,  11,  13,  15}, { 10,  12,  14,  16},
    { 10,  12,  15,  17}, { 11,  13,  15,  18}, { 11,  14,  16,  19}, { 12,  14,  17,  20},
    { 12,  15,  18,  21}, { 13,  16,  19,  22}, { 14,  17,  20,  23}, { 14,  18,  21,  24},
    { 15,  19,  22,  25}, { 16,  20,  23,  27}, { 17,  21,  25,  28}, { 18,  22,  26,  30},
    { 19,  23,  27,  31}, { 20,  24,  29,  33}, { 21,  26,  30,  35}, { 22,  27,  32,  37},
    { 23,  28,  33,  39}, { 24,  30,  35,  41}, { 26,  31,  37,  43}, { 27,  33,  39,  45},
    { 29,  35,  41,  48}, { 30,  37,  43,  50}, { 32,  39,  46,  53}, { 33,  41,  48,  56},
    { 35,  43,  51,  59}, { 37,  45,  54,  62}, { 39,  48,  56,  65}, { 41,  50,  59,  69},
    { 43,  53,  63,  72}, { 46,  56,  66,  76}, { 48,  59,  69,  80}, { 51,  62,  73,  85},
    { 53,  65,  77,  89}, { 56,  69,  81,  94}, { 59,  72,  86,  99}, { 62,  76,  90, 104},
    { 66,  80,  95, 110}, { 69,  85, 100, 116}, { 73,  89, 105, 122}, { 77,  94, 111, 128},
    { 81,  99, 117, 135}, { 85, 104, 123, 142}, { 90, 110, 130, 150}, { 95, 116, 137, 158},
    {100, 122, 144, 166}, {105, 128, 152, 175}, {111, 135, 160, 185}, {116, 142, 169, 195},
    {123, 150, 178, 205}, {128, 158, 187, 216}, {128, 167, 197, 227}, {128, 176, 208, 240}
};

/**********************************************
 * Table 9-45 of <ITU-T-REC-H.264-201201.pdf> *
 * state transition lookup table              *
 * 1. original state value. range: [2~127]    *
 * 2. input bin value. range: [0~1]           *
 **********************************************/
const uint8_t x264_cabac_transition[128][2] =
{
    {  0,   0}, {  1,   1}, {  2,  50}, { 51,   3}, {  2,  50}, { 51,   3}, {  4,  52}, { 53,   5},
    {  6,  52}, { 53,   7}, {  8,  52}, { 53,   9}, { 10,  54}, { 55,  11}, { 12,  54}, { 55,  13},
    { 14,  54}, { 55,  15}, { 16,  56}, { 57,  17}, { 18,  56}, { 57,  19}, { 20,  56}, { 57,  21},
    { 22,  58}, { 59,  23}, { 24,  58}, { 59,  25}, { 26,  60}, { 61,  27}, { 28,  60}, { 61,  29},
    { 30,  60}, { 61,  31}, { 32,  62}, { 63,  33}, { 34,  62}, { 63,  35}, { 36,  64}, { 65,  37},
    { 38,  66}, { 67,  39}, { 40,  66}, { 67,  41}, { 42,  66}, { 67,  43}, { 44,  68}, { 69,  45},
    { 46,  68}, { 69,  47}, { 48,  70}, { 71,  49}, { 50,  72}, { 73,  51}, { 52,  72}, { 73,  53},
    { 54,  74}, { 75,  55}, { 56,  74}, { 75,  57}, { 58,  76}, { 77,  59}, { 60,  78}, { 79,  61},
    { 62,  78}, { 79,  63}, { 64,  80}, { 81,  65}, { 66,  82}, { 83,  67}, { 68,  82}, { 83,  69},
    { 70,  84}, { 85,  71}, { 72,  84}, { 85,  73}, { 74,  88}, { 89,  75}, { 76,  88}, { 89,  77},
    { 78,  90}, { 91,  79}, { 80,  90}, { 91,  81}, { 82,  94}, { 95,  83}, { 84,  94}, { 95,  85},
    { 86,  96}, { 97,  87}, { 88,  96}, { 97,  89}, { 90, 100}, {101,  91}, { 92, 100}, {101,  93},
    { 94, 102}, {103,  95}, { 96, 104}, {105,  97}, { 98, 104}, {105,  99}, {100, 108}, {109, 101},
    {102, 108}, {109, 103}, {104, 110}, {111, 105}, {106, 112}, {113, 107}, {108, 114}, {115, 109},
    {110, 116}, {117, 111}, {112, 118}, {119, 113}, {114, 118}, {119, 115}, {116, 122}, {123, 117},
    {118, 122}, {123, 119}, {120, 124}, {125, 121}, {122, 126}, {127, 123}, {124, 127}, {126, 125}
};

const uint8_t x264_cabac_renorm_shift[64] =
{
    6,5,4,4,3,3,3,3,2,2,2,2,2,2,2,2,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
};

/* -ln2(probability) */
const uint16_t x264_cabac_entropy[128] =
{
    FIX8(0.0273), FIX8(5.7370), FIX8(0.0288), FIX8(5.6618),
    FIX8(0.0303), FIX8(5.5866), FIX8(0.0320), FIX8(5.5114),
    FIX8(0.0337), FIX8(5.4362), FIX8(0.0355), FIX8(5.3610),
    FIX8(0.0375), FIX8(5.2859), FIX8(0.0395), FIX8(5.2106),
    FIX8(0.0416), FIX8(5.1354), FIX8(0.0439), FIX8(5.0602),
    FIX8(0.0463), FIX8(4.9851), FIX8(0.0488), FIX8(4.9099),
    FIX8(0.0515), FIX8(4.8347), FIX8(0.0543), FIX8(4.7595),
    FIX8(0.0572), FIX8(4.6843), FIX8(0.0604), FIX8(4.6091),
    FIX8(0.0637), FIX8(4.5339), FIX8(0.0671), FIX8(4.4588),
    FIX8(0.0708), FIX8(4.3836), FIX8(0.0747), FIX8(4.3083),
    FIX8(0.0788), FIX8(4.2332), FIX8(0.0832), FIX8(4.1580),
    FIX8(0.0878), FIX8(4.0828), FIX8(0.0926), FIX8(4.0076),
    FIX8(0.0977), FIX8(3.9324), FIX8(0.1032), FIX8(3.8572),
    FIX8(0.1089), FIX8(3.7820), FIX8(0.1149), FIX8(3.7068),
    FIX8(0.1214), FIX8(3.6316), FIX8(0.1282), FIX8(3.5565),
    FIX8(0.1353), FIX8(3.4813), FIX8(0.1429), FIX8(3.4061),
    FIX8(0.1510), FIX8(3.3309), FIX8(0.1596), FIX8(3.2557),
    FIX8(0.1686), FIX8(3.1805), FIX8(0.1782), FIX8(3.1053),
    FIX8(0.1884), FIX8(3.0301), FIX8(0.1992), FIX8(2.9549),
    FIX8(0.2107), FIX8(2.8797), FIX8(0.2229), FIX8(2.8046),
    FIX8(0.2358), FIX8(2.7294), FIX8(0.2496), FIX8(2.6542),
    FIX8(0.2642), FIX8(2.5790), FIX8(0.2798), FIX8(2.5038),
    FIX8(0.2964), FIX8(2.4286), FIX8(0.3142), FIX8(2.3534),
    FIX8(0.3331), FIX8(2.2782), FIX8(0.3532), FIX8(2.2030),
    FIX8(0.3748), FIX8(2.1278), FIX8(0.3979), FIX8(2.0527),
    FIX8(0.4226), FIX8(1.9775), FIX8(0.4491), FIX8(1.9023),
    FIX8(0.4776), FIX8(1.8271), FIX8(0.5082), FIX8(1.7519),
    FIX8(0.5412), FIX8(1.6767), FIX8(0.5768), FIX8(1.6015),
    FIX8(0.6152), FIX8(1.5263), FIX8(0.6568), FIX8(1.4511),
    FIX8(0.7020), FIX8(1.3759), FIX8(0.7513), FIX8(1.3008),
    FIX8(0.8050), FIX8(1.2256), FIX8(0.8638), FIX8(1.1504),
    FIX8(0.9285), FIX8(1.0752), FIX8(1.0000), FIX8(1.0000)
};

/*******************************************************************
 * Context state table for each qp and slice type. need size: 28KB *
 * [0]: I-Slice                                                    *
 * [1]: PB-Slice and i_cabac_init_idc == 0                         *
 * [2]: PB-Slice and i_cabac_init_idc == 1 [removed]               *
 * [3]: PB-Slice and i_cabac_init_idc == 2 [removed]               *
 *******************************************************************/
uint8_t x264_cabac_contexts[2][QP_MAX_SPEC+1][276];

void x264_cabac_init( x264_t *h )
{
	int i, state;
	uint16_t qp; /* make sure 16bit x 16bit multiple */

	/* cabac init iteration: 52 * (227 + 276) = 26156. */
	for( qp = 0; qp <= QP_MAX_SPEC; qp++ )
	{
		/* set 2 for cabac range: [11 - 59] of I-slice */
		memset( x264_cabac_contexts[0][qp] + 11, 2, 49 );

		/* calculate for cabac range: [0 - 10] and [60, 275] of I-slice */
#pragma MUST_ITERATE(11, 11, 11)
		for( i = 0; i < 11; i++ )
		{
			state = x264_clip3( ((x264_cabac_context_init_I[i][0] * qp) >> 4) + x264_cabac_context_init_I[i][1], 1, 126 );
			x264_cabac_contexts[0][qp][i] = (X264_MIN( state, 127-state ) << 1) | (state >> 6);
		}
#pragma MUST_ITERATE(216, 216, 216)
		for( i = 60; i < 276; i++ )
		{
			state = x264_clip3( ((x264_cabac_context_init_I[i][0] * qp) >> 4) + x264_cabac_context_init_I[i][1], 1, 126 );
			x264_cabac_contexts[0][qp][i] = (X264_MIN( state, 127-state ) << 1) | (state >> 6);
		}

		/* calculate for cabac range: [0 - 275] of P/B-slice */
#pragma MUST_ITERATE(276, 276, 276)
		for( i = 0; i < 276; i++ )
		{
			state = x264_clip3( ((x264_cabac_context_init_PB[i][0] * qp) >> 4) + x264_cabac_context_init_PB[i][1], 1, 126 );
			x264_cabac_contexts[1][qp][i] = (X264_MIN( state, 127-state ) << 1) | (state >> 6);
		}
	}
}

/*****************************************************************************
 * x264_cabac_context_init: init cabac for current slice
 *****************************************************************************/
void x264_cabac_context_init( x264_t *h, x264_cabac_t *cb, int i_slice_type, int i_qp, int i_model )
{
	/* copy state table for current slice type and qp, model (cabac_init_idc) */
    memcpy( cb->state, x264_cabac_contexts[i_slice_type == SLICE_TYPE_I ? 0 : 1][i_qp],  276 );
}

/***********************************************************************
 * The status of the arithmetic decoding engine is represented by the  *
 * variables codIRange and codIOffset.                                 *
 * In the initialisation procedure of the arithmetic decoding process, *
 * codIRange is set equal to 510 and codIOffset is set equal to the    *
 * value returned from read_bits( 9 ) interpreted as a 9 bit binary    *
 * representation of an unsigned integer with most significant bit     *
 * written first.                                                      *
 ***********************************************************************/
void x264_cabac_encode_init( x264_cabac_t *cb, uint8_t *p_data, uint8_t *p_end )
{
    cb->i_low   = 0;
    cb->i_range = 0x01FE;
    cb->i_queue = -9; // the first bit will be shifted away and not written
    cb->i_bytes_outstanding = 0;
    cb->p_start = p_data;
    cb->p       = p_data;
    cb->p_end   = p_end;
}

static inline void x264_cabac_putbyte( x264_cabac_t *cb )
{
    if( cb->i_queue >= 0 )
    {
        int out = cb->i_low >> (cb->i_queue+10);
        cb->i_low &= (0x400<<cb->i_queue)-1;
        cb->i_queue -= 8;

        if( (out & 0xff) == 0xff )
            cb->i_bytes_outstanding++;
        else
        {
            int carry = out >> 8;
            int bytes_outstanding = cb->i_bytes_outstanding;
            // this can't modify before the beginning of the stream because
            // that would correspond to a probability > 1.
            // it will write before the beginning of the stream, which is ok
            // because a slice header always comes before cabac data.
            // this can't carry beyond the one byte, because any 0xff bytes
            // are in bytes_outstanding and thus not written yet.
            cb->p[-1] += carry;
            while( bytes_outstanding > 0 )
            {
                *(cb->p++) = carry-1;
                bytes_outstanding--;
            }
            *(cb->p++) = out;
            cb->i_bytes_outstanding = 0;
        }
    }
}

static inline void x264_cabac_encode_renorm( x264_cabac_t *cb )
{
    int shift = x264_cabac_renorm_shift[cb->i_range>>3];
    cb->i_range <<= shift;
    cb->i_low   <<= shift;
    cb->i_queue  += shift;
    x264_cabac_putbyte( cb );
}

/* Making custom versions of this function, even in asm, for the cases where
 * b is known to be 0 or 1, proved to be somewhat useful on x86_32 with GCC 3.4
 * but nearly useless with GCC 4.3 and worse than useless on x86_64. */
void x264_cabac_encode_decision_c( x264_cabac_t *cb, int i_ctx, int b )
{
    int i_state = cb->state[i_ctx];
    int i_range_lps = x264_cabac_range_lps[i_state>>1][(cb->i_range>>6)-4];
    cb->i_range -= i_range_lps;
    if( b != (i_state & 1) ) /* check whether b is LPS */
    {
        cb->i_low += cb->i_range;
        cb->i_range = i_range_lps;
    }
    cb->state[i_ctx] = x264_cabac_transition[i_state][b];
    x264_cabac_encode_renorm( cb );
}

/* Note: b is negated for this function */
void x264_cabac_encode_bypass_c( x264_cabac_t *cb, int b )
{
    cb->i_low <<= 1;
    cb->i_low += b & cb->i_range;
    cb->i_queue += 1;
    x264_cabac_putbyte( cb );
}

static const int bypass_lut[16] =
{
    -1,      0x2,     0x14,     0x68,     0x1d0,     0x7a0,     0x1f40,     0x7e80,
    0x1fd00, 0x7fa00, 0x1ff400, 0x7fe800, 0x1ffd000, 0x7ffa000, 0x1fff4000, 0x7ffe8000
};

void x264_cabac_encode_ue_bypass( x264_cabac_t *cb, int exp_bits, int val )
{
	int i;
    uint32_t v = val + (1<<exp_bits);
    int k = 31 - x264_clz( v );
    uint32_t x = (bypass_lut[k-exp_bits]<<exp_bits) + v;
    k = 2*k+1-exp_bits;
    i = ((k-1)&7)+1;
    do {
        k -= i;
        cb->i_low <<= i;
        cb->i_low += ((x>>k)&0xff) * cb->i_range;
        cb->i_queue += i;
        x264_cabac_putbyte( cb );
        i = 8;
    } while( k > 0 );
}

void x264_cabac_encode_terminal_c( x264_cabac_t *cb )
{
    cb->i_range -= 2;
    x264_cabac_encode_renorm( cb );
}

void x264_cabac_encode_flush( x264_t *h, x264_cabac_t *cb )
{
    cb->i_low += cb->i_range - 2;
    cb->i_low |= 1;
    cb->i_low <<= 9;
    cb->i_queue += 9;
    x264_cabac_putbyte( cb );
    x264_cabac_putbyte( cb );
    cb->i_low <<= -cb->i_queue;
    cb->i_low |= (0x35a4e4f5 >> (h->i_frame & 31) & 1) << 10;
    cb->i_queue = 0;
    x264_cabac_putbyte( cb );

    while( cb->i_bytes_outstanding > 0 )
    {
        *(cb->p++) = 0xff;
        cb->i_bytes_outstanding--;
    }
}
