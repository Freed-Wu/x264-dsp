/*****************************************************************************
 * set.c: quantization init
 *****************************************************************************/

#include "common.h"

#ifdef __TI_COMPILER_VERSION__

/* since we use flat cqm only, quant/dequant mf and quant bias are predefined instead of calculation */
static int x264_dequant4_mf[6][16] =
{
	{   160,  208,  160,  208,  208,  256,  208,  256,  160,  208,  160,  208,  208,  256,  208,  256 }, /* QP=0 */
	{   176,  224,  176,  224,  224,  288,  224,  288,  176,  224,  176,  224,  224,  288,  224,  288 }, /* QP=1 */
	{   208,  256,  208,  256,  256,  320,  256,  320,  208,  256,  208,  256,  256,  320,  256,  320 }, /* QP=2 */
	{   224,  288,  224,  288,  288,  368,  288,  368,  224,  288,  224,  288,  288,  368,  288,  368 }, /* QP=3 */
	{   256,  320,  256,  320,  320,  400,  320,  400,  256,  320,  256,  320,  320,  400,  320,  400 }, /* QP=4 */
	{   288,  368,  288,  368,  368,  464,  368,  464,  288,  368,  288,  368,  368,  464,  368,  464 }  /* QP=5 */
};

static uint16_t x264_quant4_mf[70][16] =
{
	{ 26214,16132,26214,16132,16132,10486,16132,10486,26214,16132,26214,16132,16132,10486,16132,10486 }, /* QP=0 */
	{ 23832,14980,23832,14980,14980, 9320,14980, 9320,23832,14980,23832,14980,14980, 9320,14980, 9320 }, /* QP=1 */
	{ 20164,13108,20164,13108,13108, 8388,13108, 8388,20164,13108,20164,13108,13108, 8388,13108, 8388 }, /* QP=2 */
	{ 18724,11650,18724,11650,11650, 7294,11650, 7294,18724,11650,18724,11650,11650, 7294,11650, 7294 }, /* QP=3 */
	{ 16384,10486,16384,10486,10486, 6710,10486, 6710,16384,10486,16384,10486,10486, 6710,10486, 6710 }, /* QP=4 */
	{ 14564, 9118,14564, 9118, 9118, 5786, 9118, 5786,14564, 9118,14564, 9118, 9118, 5786, 9118, 5786 }, /* QP=5 */
	{ 13107, 8066,13107, 8066, 8066, 5243, 8066, 5243,13107, 8066,13107, 8066, 8066, 5243, 8066, 5243 }, /* QP=6 */
	{ 11916, 7490,11916, 7490, 7490, 4660, 7490, 4660,11916, 7490,11916, 7490, 7490, 4660, 7490, 4660 }, /* QP=7 */
	{ 10082, 6554,10082, 6554, 6554, 4194, 6554, 4194,10082, 6554,10082, 6554, 6554, 4194, 6554, 4194 }, /* QP=8 */
	{  9362, 5825, 9362, 5825, 5825, 3647, 5825, 3647, 9362, 5825, 9362, 5825, 5825, 3647, 5825, 3647 }, /* QP=9 */
	{  8192, 5243, 8192, 5243, 5243, 3355, 5243, 3355, 8192, 5243, 8192, 5243, 5243, 3355, 5243, 3355 }, /* QP=10 */
	{  7282, 4559, 7282, 4559, 4559, 2893, 4559, 2893, 7282, 4559, 7282, 4559, 4559, 2893, 4559, 2893 }, /* QP=11 */
	{  6554, 4033, 6554, 4033, 4033, 2622, 4033, 2622, 6554, 4033, 6554, 4033, 4033, 2622, 4033, 2622 }, /* QP=12 */
	{  5958, 3745, 5958, 3745, 3745, 2330, 3745, 2330, 5958, 3745, 5958, 3745, 3745, 2330, 3745, 2330 }, /* QP=13 */
	{  5041, 3277, 5041, 3277, 3277, 2097, 3277, 2097, 5041, 3277, 5041, 3277, 3277, 2097, 3277, 2097 }, /* QP=14 */
	{  4681, 2913, 4681, 2913, 2913, 1824, 2913, 1824, 4681, 2913, 4681, 2913, 2913, 1824, 2913, 1824 }, /* QP=15 */
	{  4096, 2622, 4096, 2622, 2622, 1678, 2622, 1678, 4096, 2622, 4096, 2622, 2622, 1678, 2622, 1678 }, /* QP=16 */
	{  3641, 2280, 3641, 2280, 2280, 1447, 2280, 1447, 3641, 2280, 3641, 2280, 2280, 1447, 2280, 1447 }, /* QP=17 */
	{  3277, 2017, 3277, 2017, 2017, 1311, 2017, 1311, 3277, 2017, 3277, 2017, 2017, 1311, 2017, 1311 }, /* QP=18 */
	{  2979, 1873, 2979, 1873, 1873, 1165, 1873, 1165, 2979, 1873, 2979, 1873, 1873, 1165, 1873, 1165 }, /* QP=19 */
	{  2521, 1639, 2521, 1639, 1639, 1049, 1639, 1049, 2521, 1639, 2521, 1639, 1639, 1049, 1639, 1049 }, /* QP=20 */
	{  2341, 1456, 2341, 1456, 1456,  912, 1456,  912, 2341, 1456, 2341, 1456, 1456,  912, 1456,  912 }, /* QP=21 */
	{  2048, 1311, 2048, 1311, 1311,  839, 1311,  839, 2048, 1311, 2048, 1311, 1311,  839, 1311,  839 }, /* QP=22 */
	{  1821, 1140, 1821, 1140, 1140,  723, 1140,  723, 1821, 1140, 1821, 1140, 1140,  723, 1140,  723 }, /* QP=23 */
	{  1638, 1008, 1638, 1008, 1008,  655, 1008,  655, 1638, 1008, 1638, 1008, 1008,  655, 1008,  655 }, /* QP=24 */
	{  1490,  936, 1490,  936,  936,  583,  936,  583, 1490,  936, 1490,  936,  936,  583,  936,  583 }, /* QP=25 */
	{  1260,  819, 1260,  819,  819,  524,  819,  524, 1260,  819, 1260,  819,  819,  524,  819,  524 }, /* QP=26 */
	{  1170,  728, 1170,  728,  728,  456,  728,  456, 1170,  728, 1170,  728,  728,  456,  728,  456 }, /* QP=27 */
	{  1024,  655, 1024,  655,  655,  419,  655,  419, 1024,  655, 1024,  655,  655,  419,  655,  419 }, /* QP=28 */
	{   910,  570,  910,  570,  570,  362,  570,  362,  910,  570,  910,  570,  570,  362,  570,  362 }, /* QP=29 */
	{   819,  504,  819,  504,  504,  328,  504,  328,  819,  504,  819,  504,  504,  328,  504,  328 }, /* QP=30 */
	{   745,  468,  745,  468,  468,  291,  468,  291,  745,  468,  745,  468,  468,  291,  468,  291 }, /* QP=31 */
	{   630,  410,  630,  410,  410,  262,  410,  262,  630,  410,  630,  410,  410,  262,  410,  262 }, /* QP=32 */
	{   585,  364,  585,  364,  364,  228,  364,  228,  585,  364,  585,  364,  364,  228,  364,  228 }, /* QP=33 */
	{   512,  328,  512,  328,  328,  210,  328,  210,  512,  328,  512,  328,  328,  210,  328,  210 }, /* QP=34 */
	{   455,  285,  455,  285,  285,  181,  285,  181,  455,  285,  455,  285,  285,  181,  285,  181 }, /* QP=35 */
	{   410,  252,  410,  252,  252,  164,  252,  164,  410,  252,  410,  252,  252,  164,  252,  164 }, /* QP=36 */
	{   372,  234,  372,  234,  234,  146,  234,  146,  372,  234,  372,  234,  234,  146,  234,  146 }, /* QP=37 */
	{   315,  205,  315,  205,  205,  131,  205,  131,  315,  205,  315,  205,  205,  131,  205,  131 }, /* QP=38 */
	{   293,  182,  293,  182,  182,  114,  182,  114,  293,  182,  293,  182,  182,  114,  182,  114 }, /* QP=39 */
	{   256,  164,  256,  164,  164,  105,  164,  105,  256,  164,  256,  164,  164,  105,  164,  105 }, /* QP=40 */
	{   228,  142,  228,  142,  142,   90,  142,   90,  228,  142,  228,  142,  142,   90,  142,   90 }, /* QP=41 */
	{   205,  126,  205,  126,  126,   82,  126,   82,  205,  126,  205,  126,  126,   82,  126,   82 }, /* QP=42 */
	{   186,  117,  186,  117,  117,   73,  117,   73,  186,  117,  186,  117,  117,   73,  117,   73 }, /* QP=43 */
	{   158,  102,  158,  102,  102,   66,  102,   66,  158,  102,  158,  102,  102,   66,  102,   66 }, /* QP=44 */
	{   146,   91,  146,   91,   91,   57,   91,   57,  146,   91,  146,   91,   91,   57,   91,   57 }, /* QP=45 */
	{   128,   82,  128,   82,   82,   52,   82,   52,  128,   82,  128,   82,   82,   52,   82,   52 }, /* QP=46 */
	{   114,   71,  114,   71,   71,   45,   71,   45,  114,   71,  114,   71,   71,   45,   71,   45 }, /* QP=47 */
	{   102,   63,  102,   63,   63,   41,   63,   41,  102,   63,  102,   63,   63,   41,   63,   41 }, /* QP=48 */
	{    93,   59,   93,   59,   59,   36,   59,   36,   93,   59,   93,   59,   59,   36,   59,   36 }, /* QP=49 */
	{    79,   51,   79,   51,   51,   33,   51,   33,   79,   51,   79,   51,   51,   33,   51,   33 }, /* QP=50 */
	{    73,   46,   73,   46,   46,   28,   46,   28,   73,   46,   73,   46,   46,   28,   46,   28 }, /* QP=51 */
	{    64,   41,   64,   41,   41,   26,   41,   26,   64,   41,   64,   41,   41,   26,   41,   26 }, /* QP=52 */
	{    57,   36,   57,   36,   36,   23,   36,   23,   57,   36,   57,   36,   36,   23,   36,   23 }, /* QP=53 */
	{    51,   32,   51,   32,   32,   20,   32,   20,   51,   32,   51,   32,   32,   20,   32,   20 }, /* QP=54 */
	{    47,   29,   47,   29,   29,   18,   29,   18,   47,   29,   47,   29,   29,   18,   29,   18 }, /* QP=55 */
	{    39,   26,   39,   26,   26,   16,   26,   16,   39,   26,   39,   26,   26,   16,   26,   16 }, /* QP=56 */
	{    37,   23,   37,   23,   23,   14,   23,   14,   37,   23,   37,   23,   23,   14,   23,   14 }, /* QP=57 */
	{    32,   20,   32,   20,   20,   13,   20,   13,   32,   20,   32,   20,   20,   13,   20,   13 }, /* QP=58 */
	{    28,   18,   28,   18,   18,   11,   18,   11,   28,   18,   28,   18,   18,   11,   18,   11 }, /* QP=59 */
	{    26,   16,   26,   16,   16,   10,   16,   10,   26,   16,   26,   16,   16,   10,   16,   10 }, /* QP=60 */
	{    23,   15,   23,   15,   15,    9,   15,    9,   23,   15,   23,   15,   15,    9,   15,    9 }, /* QP=61 */
	{    20,   13,   20,   13,   13,    8,   13,    8,   20,   13,   20,   13,   13,    8,   13,    8 }, /* QP=62 */
	{    18,   11,   18,   11,   11,    7,   11,    7,   18,   11,   18,   11,   11,    7,   11,    7 }, /* QP=63 */
	{    16,   10,   16,   10,   10,    7,   10,    7,   16,   10,   16,   10,   10,    7,   10,    7 }, /* QP=64 */
	{    14,    9,   14,    9,    9,    6,    9,    6,   14,    9,   14,    9,    9,    6,    9,    6 }, /* QP=65 */
	{    13,    8,   13,    8,    8,    5,    8,    5,   13,    8,   13,    8,    8,    5,    8,    5 }, /* QP=66 */
	{    12,    7,   12,    7,    7,    5,    7,    5,   12,    7,   12,    7,    7,    5,    7,    5 }, /* QP=67 */
	{    10,    6,   10,    6,    6,    4,    6,    4,   10,    6,   10,    6,    6,    4,    6,    4 }, /* QP=68 */
	{     9,    6,    9,    6,    6,    4,    6,    4,    9,    6,    9,    6,    6,    4,    6,    4 }  /* QP=69 */
};

static uint16_t x264_quant4_bias_intra[70][16] =
{
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=0 */
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=1 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=2 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=3 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=4 */
	{     1,    2,    1,    2,    2,    4,    2,    4,    1,    2,    1,    2,    2,    4,    2,    4 }, /* QP=5 */
	{     2,    3,    2,    3,    3,    4,    3,    4,    2,    3,    2,    3,    3,    4,    3,    4 }, /* QP=6 */
	{     2,    3,    2,    3,    3,    5,    3,    5,    2,    3,    2,    3,    3,    5,    3,    5 }, /* QP=7 */
	{     2,    3,    2,    3,    3,    5,    3,    5,    2,    3,    2,    3,    3,    5,    3,    5 }, /* QP=8 */
	{     2,    4,    2,    4,    4,    6,    4,    6,    2,    4,    2,    4,    4,    6,    4,    6 }, /* QP=9 */
	{     3,    4,    3,    4,    4,    6,    4,    6,    3,    4,    3,    4,    4,    6,    4,    6 }, /* QP=10 */
	{     3,    5,    3,    5,    5,    7,    5,    7,    3,    5,    3,    5,    5,    7,    5,    7 }, /* QP=11 */
	{     3,    5,    3,    5,    5,    8,    5,    8,    3,    5,    3,    5,    5,    8,    5,    8 }, /* QP=12 */
	{     4,    6,    4,    6,    6,    9,    6,    9,    4,    6,    4,    6,    6,    9,    6,    9 }, /* QP=13 */
	{     4,    7,    4,    7,    7,   10,    7,   10,    4,    7,    4,    7,    7,   10,    7,   10 }, /* QP=14 */
	{     5,    7,    5,    7,    7,   12,    7,   12,    5,    7,    5,    7,    7,   12,    7,   12 }, /* QP=15 */
	{     5,    8,    5,    8,    8,   13,    8,   13,    5,    8,    5,    8,    8,   13,    8,   13 }, /* QP=16 */
	{     6,    9,    6,    9,    9,   15,    9,   15,    6,    9,    6,    9,    9,   15,    9,   15 }, /* QP=17 */
	{     7,   11,    7,   11,   11,   16,   11,   16,    7,   11,    7,   11,   11,   16,   11,   16 }, /* QP=18 */
	{     7,   11,    7,   11,   11,   18,   11,   18,    7,   11,    7,   11,   11,   18,   11,   18 }, /* QP=19 */
	{     9,   13,    9,   13,   13,   20,   13,   20,    9,   13,    9,   13,   13,   20,   13,   20 }, /* QP=20 */
	{     9,   15,    9,   15,   15,   24,   15,   24,    9,   15,    9,   15,   15,   24,   15,   24 }, /* QP=21 */
	{    11,   16,   11,   16,   16,   26,   16,   26,   11,   16,   11,   16,   16,   26,   16,   26 }, /* QP=22 */
	{    12,   19,   12,   19,   19,   30,   19,   30,   12,   19,   12,   19,   19,   30,   19,   30 }, /* QP=23 */
	{    13,   21,   13,   21,   21,   33,   21,   33,   13,   21,   13,   21,   21,   33,   21,   33 }, /* QP=24 */
	{    14,   23,   14,   23,   23,   37,   23,   37,   14,   23,   14,   23,   23,   37,   23,   37 }, /* QP=25 */
	{    17,   26,   17,   26,   26,   41,   26,   41,   17,   26,   17,   26,   26,   41,   26,   41 }, /* QP=26 */
	{    18,   30,   18,   30,   30,   47,   30,   47,   18,   30,   18,   30,   30,   47,   30,   47 }, /* QP=27 */
	{    21,   33,   21,   33,   33,   51,   33,   51,   21,   33,   21,   33,   33,   51,   33,   51 }, /* QP=28 */
	{    24,   38,   24,   38,   38,   59,   38,   59,   24,   38,   24,   38,   38,   59,   38,   59 }, /* QP=29 */
	{    26,   43,   26,   43,   43,   66,   43,   66,   26,   43,   26,   43,   43,   66,   43,   66 }, /* QP=30 */
	{    29,   46,   29,   46,   46,   74,   46,   74,   29,   46,   29,   46,   46,   74,   46,   74 }, /* QP=31 */
	{    34,   52,   34,   52,   52,   82,   52,   82,   34,   52,   34,   52,   52,   82,   52,   82 }, /* QP=32 */
	{    37,   59,   37,   59,   59,   94,   59,   94,   37,   59,   37,   59,   59,   94,   59,   94 }, /* QP=33 */
	{    42,   66,   42,   66,   66,  102,   66,  102,   42,   66,   42,   66,   66,  102,   66,  102 }, /* QP=34 */
	{    47,   75,   47,   75,   75,  119,   75,  119,   47,   75,   47,   75,   75,  119,   75,  119 }, /* QP=35 */
	{    52,   85,   52,   85,   85,  131,   85,  131,   52,   85,   52,   85,   85,  131,   85,  131 }, /* QP=36 */
	{    58,   92,   58,   92,   92,  147,   92,  147,   58,   92,   58,   92,   92,  147,   92,  147 }, /* QP=37 */
	{    68,  105,   68,  105,  105,  164,  105,  164,   68,  105,   68,  105,  105,  164,  105,  164 }, /* QP=38 */
	{    73,  118,   73,  118,  118,  189,  118,  189,   73,  118,   73,  118,  118,  189,  118,  189 }, /* QP=39 */
	{    84,  131,   84,  131,  131,  205,  131,  205,   84,  131,   84,  131,  131,  205,  131,  205 }, /* QP=40 */
	{    94,  151,   94,  151,  151,  239,  151,  239,   94,  151,   94,  151,  151,  239,  151,  239 }, /* QP=41 */
	{   105,  171,  105,  171,  171,  262,  171,  262,  105,  171,  105,  171,  171,  262,  171,  262 }, /* QP=42 */
	{   116,  184,  116,  184,  184,  295,  184,  295,  116,  184,  116,  184,  184,  295,  184,  295 }, /* QP=43 */
	{   136,  211,  136,  211,  211,  326,  211,  326,  136,  211,  136,  211,  211,  326,  211,  326 }, /* QP=44 */
	{   147,  236,  147,  236,  236,  377,  236,  377,  147,  236,  147,  236,  236,  377,  236,  377 }, /* QP=45 */
	{   168,  262,  168,  262,  262,  414,  262,  414,  168,  262,  168,  262,  262,  414,  262,  414 }, /* QP=46 */
	{   189,  303,  189,  303,  303,  478,  303,  478,  189,  303,  189,  303,  303,  478,  303,  478 }, /* QP=47 */
	{   211,  341,  211,  341,  341,  524,  341,  524,  211,  341,  211,  341,  341,  524,  341,  524 }, /* QP=48 */
	{   231,  364,  231,  364,  364,  597,  364,  597,  231,  364,  231,  364,  364,  597,  364,  597 }, /* QP=49 */
	{   272,  422,  272,  422,  422,  652,  422,  652,  272,  422,  272,  422,  422,  652,  422,  652 }, /* QP=50 */
	{   295,  467,  295,  467,  467,  768,  467,  768,  295,  467,  295,  467,  467,  768,  467,  768 }, /* QP=51 */
	{   336,  524,  336,  524,  524,  827,  524,  827,  336,  524,  336,  524,  524,  827,  524,  827 }, /* QP=52 */
	{   377,  597,  377,  597,  597,  935,  597,  935,  377,  597,  377,  597,  597,  935,  597,  935 }, /* QP=53 */
	{   422,  672,  422,  672,  672, 1075,  672, 1075,  422,  672,  422,  672,  672, 1075,  672, 1075 }, /* QP=54 */
	{   458,  742,  458,  742,  742, 1195,  742, 1195,  458,  742,  458,  742,  742, 1195,  742, 1195 }, /* QP=55 */
	{   551,  827,  551,  827,  827, 1344,  827, 1344,  551,  827,  551,  827,  827, 1344,  827, 1344 }, /* QP=56 */
	{   581,  935,  581,  935,  935, 1536,  935, 1536,  581,  935,  581,  935,  935, 1536,  935, 1536 }, /* QP=57 */
	{   672, 1075,  672, 1075, 1075, 1654, 1075, 1654,  672, 1075,  672, 1075, 1075, 1654, 1075, 1654 }, /* QP=58 */
	{   768, 1195,  768, 1195, 1195, 1955, 1195, 1955,  768, 1195,  768, 1195, 1195, 1955, 1195, 1955 }, /* QP=59 */
	{   827, 1344,  827, 1344, 1344, 2150, 1344, 2150,  827, 1344,  827, 1344, 1344, 2150, 1344, 2150 }, /* QP=60 */
	{   935, 1434,  935, 1434, 1434, 2389, 1434, 2389,  935, 1434,  935, 1434, 1434, 2389, 1434, 2389 }, /* QP=61 */
	{  1075, 1654, 1075, 1654, 1654, 2688, 1654, 2688, 1075, 1654, 1075, 1654, 1654, 2688, 1654, 2688 }, /* QP=62 */
	{  1195, 1955, 1195, 1955, 1955, 3072, 1955, 3072, 1195, 1955, 1195, 1955, 1955, 3072, 1955, 3072 }, /* QP=63 */
	{  1344, 2150, 1344, 2150, 2150, 3072, 2150, 3072, 1344, 2150, 1344, 2150, 2150, 3072, 2150, 3072 }, /* QP=64 */
	{  1536, 2389, 1536, 2389, 2389, 3584, 2389, 3584, 1536, 2389, 1536, 2389, 2389, 3584, 2389, 3584 }, /* QP=65 */
	{  1654, 2688, 1654, 2688, 2688, 4301, 2688, 4301, 1654, 2688, 1654, 2688, 2688, 4301, 2688, 4301 }, /* QP=66 */
	{  1792, 3072, 1792, 3072, 3072, 4301, 3072, 4301, 1792, 3072, 1792, 3072, 3072, 4301, 3072, 4301 }, /* QP=67 */
	{  2150, 3584, 2150, 3584, 3584, 5376, 3584, 5376, 2150, 3584, 2150, 3584, 3584, 5376, 3584, 5376 }, /* QP=68 */
	{  2389, 3584, 2389, 3584, 3584, 5376, 3584, 5376, 2389, 3584, 2389, 3584, 3584, 5376, 3584, 5376 }  /* QP=69 */
};

static uint16_t x264_quant4_bias_inter[70][16] =
{
	{     0,    1,    0,    1,    1,    1,    1,    1,    0,    1,    0,    1,    1,    1,    1,    1 }, /* QP=0 */
	{     0,    1,    0,    1,    1,    1,    1,    1,    0,    1,    0,    1,    1,    1,    1,    1 }, /* QP=1 */
	{     1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1 }, /* QP=2 */
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=3 */
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=4 */
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=5 */
	{     1,    1,    1,    1,    1,    2,    1,    2,    1,    1,    1,    1,    1,    2,    1,    2 }, /* QP=6 */
	{     1,    2,    1,    2,    2,    2,    2,    2,    1,    2,    1,    2,    2,    2,    2,    2 }, /* QP=7 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=8 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=9 */
	{     1,    2,    1,    2,    2,    3,    2,    3,    1,    2,    1,    2,    2,    3,    2,    3 }, /* QP=10 */
	{     2,    2,    2,    2,    2,    4,    2,    4,    2,    2,    2,    2,    2,    4,    2,    4 }, /* QP=11 */
	{     2,    3,    2,    3,    3,    4,    3,    4,    2,    3,    2,    3,    3,    4,    3,    4 }, /* QP=12 */
	{     2,    3,    2,    3,    3,    5,    3,    5,    2,    3,    2,    3,    3,    5,    3,    5 }, /* QP=13 */
	{     2,    3,    2,    3,    3,    5,    3,    5,    2,    3,    2,    3,    3,    5,    3,    5 }, /* QP=14 */
	{     2,    4,    2,    4,    4,    6,    4,    6,    2,    4,    2,    4,    4,    6,    4,    6 }, /* QP=15 */
	{     3,    4,    3,    4,    4,    7,    4,    7,    3,    4,    3,    4,    4,    7,    4,    7 }, /* QP=16 */
	{     3,    5,    3,    5,    5,    8,    5,    8,    3,    5,    3,    5,    5,    8,    5,    8 }, /* QP=17 */
	{     3,    6,    3,    6,    6,    9,    6,    9,    3,    6,    3,    6,    6,    9,    6,    9 }, /* QP=18 */
	{     4,    6,    4,    6,    6,   10,    6,   10,    4,    6,    4,    6,    6,   10,    6,   10 }, /* QP=19 */
	{     4,    7,    4,    7,    7,   11,    7,   11,    4,    7,    4,    7,    7,   11,    7,   11 }, /* QP=20 */
	{     5,    8,    5,    8,    8,   12,    8,   12,    5,    8,    5,    8,    8,   12,    8,   12 }, /* QP=21 */
	{     6,    9,    6,    9,    9,   13,    9,   13,    6,    9,    6,    9,    9,   13,    9,   13 }, /* QP=22 */
	{     6,   10,    6,   10,   10,   16,   10,   16,    6,   10,    6,   10,   10,   16,   10,   16 }, /* QP=23 */
	{     7,   11,    7,   11,   11,   17,   11,   17,    7,   11,    7,   11,   11,   17,   11,   17 }, /* QP=24 */
	{     8,   12,    8,   12,   12,   19,   12,   19,    8,   12,    8,   12,   12,   19,   12,   19 }, /* QP=25 */
	{     9,   14,    9,   14,   14,   21,   14,   21,    9,   14,    9,   14,   14,   21,   14,   21 }, /* QP=26 */
	{    10,   15,   10,   15,   15,   25,   15,   25,   10,   15,   10,   15,   15,   25,   15,   25 }, /* QP=27 */
	{    11,   17,   11,   17,   17,   27,   17,   27,   11,   17,   11,   17,   17,   27,   17,   27 }, /* QP=28 */
	{    12,   20,   12,   20,   20,   31,   20,   31,   12,   20,   12,   20,   20,   31,   20,   31 }, /* QP=29 */
	{    14,   22,   14,   22,   22,   34,   22,   34,   14,   22,   14,   22,   22,   34,   22,   34 }, /* QP=30 */
	{    15,   24,   15,   24,   24,   39,   24,   39,   15,   24,   15,   24,   24,   39,   24,   39 }, /* QP=31 */
	{    18,   27,   18,   27,   27,   43,   27,   43,   18,   27,   18,   27,   27,   43,   27,   43 }, /* QP=32 */
	{    19,   31,   19,   31,   31,   49,   31,   49,   19,   31,   19,   31,   31,   49,   31,   49 }, /* QP=33 */
	{    22,   34,   22,   34,   34,   54,   34,   54,   22,   34,   22,   34,   34,   54,   34,   54 }, /* QP=34 */
	{    25,   40,   25,   40,   40,   62,   40,   62,   25,   40,   25,   40,   40,   62,   40,   62 }, /* QP=35 */
	{    27,   45,   27,   45,   45,   69,   45,   69,   27,   45,   27,   45,   45,   69,   45,   69 }, /* QP=36 */
	{    30,   48,   30,   48,   48,   77,   48,   77,   30,   48,   30,   48,   48,   77,   48,   77 }, /* QP=37 */
	{    36,   55,   36,   55,   55,   86,   55,   86,   36,   55,   36,   55,   55,   86,   55,   86 }, /* QP=38 */
	{    38,   62,   38,   62,   62,   99,   62,   99,   38,   62,   38,   62,   62,   99,   62,   99 }, /* QP=39 */
	{    44,   69,   44,   69,   69,  107,   69,  107,   44,   69,   44,   69,   69,  107,   69,  107 }, /* QP=40 */
	{    49,   79,   49,   79,   79,  125,   79,  125,   49,   79,   49,   79,   79,  125,   79,  125 }, /* QP=41 */
	{    55,   89,   55,   89,   89,  137,   89,  137,   55,   89,   55,   89,   89,  137,   89,  137 }, /* QP=42 */
	{    61,   96,   61,   96,   96,  154,   96,  154,   61,   96,   61,   96,   96,  154,   96,  154 }, /* QP=43 */
	{    71,  110,   71,  110,  110,  171,  110,  171,   71,  110,   71,  110,  110,  171,  110,  171 }, /* QP=44 */
	{    77,  124,   77,  124,  124,  198,  124,  198,   77,  124,   77,  124,  124,  198,  124,  198 }, /* QP=45 */
	{    88,  137,   88,  137,  137,  217,  137,  217,   88,  137,   88,  137,  137,  217,  137,  217 }, /* QP=46 */
	{    99,  159,   99,  159,  159,  250,  159,  250,   99,  159,   99,  159,  159,  250,  159,  250 }, /* QP=47 */
	{   110,  179,  110,  179,  179,  275,  179,  275,  110,  179,  110,  179,  179,  275,  179,  275 }, /* QP=48 */
	{   121,  191,  121,  191,  191,  313,  191,  313,  121,  191,  121,  191,  191,  313,  191,  313 }, /* QP=49 */
	{   143,  221,  143,  221,  221,  341,  221,  341,  143,  221,  143,  221,  221,  341,  221,  341 }, /* QP=50 */
	{   154,  245,  154,  245,  245,  402,  245,  402,  154,  245,  154,  245,  245,  402,  245,  402 }, /* QP=51 */
	{   176,  275,  176,  275,  275,  433,  275,  433,  176,  275,  176,  275,  275,  433,  275,  433 }, /* QP=52 */
	{   198,  313,  198,  313,  313,  490,  313,  490,  198,  313,  198,  313,  313,  490,  313,  490 }, /* QP=53 */
	{   221,  352,  221,  352,  352,  563,  352,  563,  221,  352,  221,  352,  352,  563,  352,  563 }, /* QP=54 */
	{   240,  388,  240,  388,  388,  626,  388,  626,  240,  388,  240,  388,  388,  626,  388,  626 }, /* QP=55 */
	{   289,  433,  289,  433,  433,  704,  433,  704,  289,  433,  289,  433,  433,  704,  433,  704 }, /* QP=56 */
	{   304,  490,  304,  490,  490,  805,  490,  805,  304,  490,  304,  490,  490,  805,  490,  805 }, /* QP=57 */
	{   352,  563,  352,  563,  563,  866,  563,  866,  352,  563,  352,  563,  563,  866,  563,  866 }, /* QP=58 */
	{   402,  626,  402,  626,  626, 1024,  626, 1024,  402,  626,  402,  626,  626, 1024,  626, 1024 }, /* QP=59 */
	{   433,  704,  433,  704,  704, 1126,  704, 1126,  433,  704,  433,  704,  704, 1126,  704, 1126 }, /* QP=60 */
	{   490,  751,  490,  751,  751, 1252,  751, 1252,  490,  751,  490,  751,  751, 1252,  751, 1252 }, /* QP=61 */
	{   563,  866,  563,  866,  866, 1408,  866, 1408,  563,  866,  563,  866,  866, 1408,  866, 1408 }, /* QP=62 */
	{   626, 1024,  626, 1024, 1024, 1609, 1024, 1609,  626, 1024,  626, 1024, 1024, 1609, 1024, 1609 }, /* QP=63 */
	{   704, 1126,  704, 1126, 1126, 1609, 1126, 1609,  704, 1126,  704, 1126, 1126, 1609, 1126, 1609 }, /* QP=64 */
	{   805, 1252,  805, 1252, 1252, 1877, 1252, 1877,  805, 1252,  805, 1252, 1252, 1877, 1252, 1877 }, /* QP=65 */
	{   866, 1408,  866, 1408, 1408, 2253, 1408, 2253,  866, 1408,  866, 1408, 1408, 2253, 1408, 2253 }, /* QP=66 */
	{   939, 1609,  939, 1609, 1609, 2253, 1609, 2253,  939, 1609,  939, 1609, 1609, 2253, 1609, 2253 }, /* QP=67 */
	{  1126, 1877, 1126, 1877, 1877, 2816, 1877, 2816, 1126, 1877, 1126, 1877, 1877, 2816, 1877, 2816 }, /* QP=68 */
	{  1252, 1877, 1252, 1877, 1877, 2816, 1877, 2816, 1252, 1877, 1252, 1877, 1877, 2816, 1877, 2816 }  /* QP=69 */
};

int x264_cqm_init( x264_t *h )
{
    int i;

#pragma MUST_ITERATE(4, 4, 4)
    for( i = 0; i < 4; i++ )
    {
    	h->  quant4_mf[i] = x264_quant4_mf;
    	h->dequant4_mf[i] = x264_dequant4_mf;
    }

    h->quant4_bias[2] = h->quant4_bias[0] = x264_quant4_bias_intra; /* quant bias for intra chroma/luma */
    h->quant4_bias[3] = h->quant4_bias[1] = x264_quant4_bias_inter; /* quant bias for inter chroma/luma */

    return 0;
}

void x264_cqm_delete( x264_t *h )
{
}

#else

#define SHIFT(x,s) ((s)<=0 ? (x)<<-(s) : ((x)+(1<<((s)-1)))>>(s))
#define DIV(n,d) (((n) + ((d)>>1)) / (d))

static const uint8_t dequant4_scale[6][3] =
{
    { 10, 13, 16 }, /* QP=0 */
    { 11, 14, 18 }, /* QP=1 */
    { 13, 16, 20 }, /* QP=2 */
    { 14, 18, 23 }, /* QP=3 */
    { 16, 20, 25 }, /* QP=4 */
    { 18, 23, 29 }  /* QP=5 */
};
static const uint16_t quant4_scale[6][3] =
{
    { 13107, 8066, 5243 }, /* QP=0 */
    { 11916, 7490, 4660 }, /* QP=1 */
    { 10082, 6554, 4194 }, /* QP=2 */
    {  9362, 5825, 3647 }, /* QP=3 */
    {  8192, 5243, 3355 }, /* QP=4 */
    {  7282, 4559, 2893 }, /* QP=5 */
};

int x264_cqm_init( x264_t *h )
{
	uint16_t def_quant4[6][16];   /* default 4x4 quant mf */
    uint8_t def_dequant4[6][16];  /* default 4x4 dequant mf */
    int deadzone[4] = { 32 - h->param.analyse.i_luma_deadzone[1], /* 32 - 11 */
                        32 - h->param.analyse.i_luma_deadzone[0], /* 32 - 21 */
                        32 - 11, 32 - 21 };
    udctcoef mf;
    int q, i;

    /* since we use flat cqm, only malloc one quant/dequant mf here */
    CHECKED_MALLOC( h->  quant4_mf[0], (QP_MAX+1)*16*sizeof(udctcoef) );
    CHECKED_MALLOC( h->dequant4_mf[0],  6*16*sizeof(int) );
#pragma MUST_ITERATE(3, 3, 3)
    for( i = 1; i < 4; i++ )
    {
    	h->  quant4_mf[i] = h->  quant4_mf[0];
    	h->dequant4_mf[i] = h->dequant4_mf[0];
    }

    /* since we use default luma deadzone, set chroma bias = luma bias */
    CHECKED_MALLOC( h->quant4_bias[0], (QP_MAX+1)*16*sizeof(udctcoef) ); /* quant bias for intra luma */
    CHECKED_MALLOC( h->quant4_bias[1], (QP_MAX+1)*16*sizeof(udctcoef) ); /* quant bias for inter luma */
    h->quant4_bias[2] = h->quant4_bias[0]; /* quant bias for intra chroma */
    h->quant4_bias[3] = h->quant4_bias[1]; /* quant bias for inter chroma */

    /* init default quant/dequant mf from quant4_scale/dequant4_scale */
    for( q = 0; q < 6; q++ )
    {
#pragma MUST_ITERATE(16, 16, 16)
        for( i = 0; i < 16; i++ )
        {
            int j = (i&1) + ((i>>2)&1);
            def_dequant4[q][i] = dequant4_scale[q][j];
            def_quant4[q][i]   =   quant4_scale[q][j];
        }
    }

    /* since we use flat cqm, only compute first dequant mf here */
    for( q = 0; q < 6; q++ )
    {
#pragma MUST_ITERATE(16, 16, 16)
		for( i = 0; i < 16; i++ )
			h->dequant4_mf[0][q][i] = def_dequant4[q][i] * h->pps->scaling_list[0][i]; /* UINT8 * UINT8 */
    }

    /* FIXME: 70 * 16 = 1120 iterations, cost: 22,0000 cpu cycles.
     * define constants for quant4_bias instead of division.
     */
    for( q = 0; q < QP_MAX+1; q++ )
    {
#pragma MUST_ITERATE(16, 16, 16)
		for( i = 0; i < 16; i++ )
		{
			mf = SHIFT(def_quant4[q%6][i], q/6 - 1);
			h->quant4_mf[0][q][i] = mf;
			// round to nearest, unless that would cause the deadzone to be negative
			h->quant4_bias[0][q][i] = X264_MIN( DIV(deadzone[0]<<10, mf), (1<<15)/mf );
			h->quant4_bias[1][q][i] = X264_MIN( DIV(deadzone[1]<<10, mf), (1<<15)/mf );
		}
    }

    return 0;
fail:
	x264_cqm_delete( h );
	return -1;
}

void x264_cqm_delete( x264_t *h )
{
	x264_free( h->  quant4_mf[0] );
	x264_free( h->dequant4_mf[0] );
	x264_free( h->quant4_bias[0] );
	x264_free( h->quant4_bias[1] );
}

#endif
